name: Tests And Coverage

on:
  push:
    branches: [ main ]
jobs:
  thomas-api-tests-and-coverage:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Docker Up
        run: docker-compose up -d
      - name: Get .env
        env:
          LDB_KEY: ${{ secrets.LDB_KEY }}
          KB_USER: ${{ secrets.KB_USER }}
          KB_PASS: ${{ secrets.KB_PASS }}
          KBRTI_USER: ${{ secrets.KBRTI_USER }}
          KBRTI_PASS: ${{ secrets.KBRTI_PASS }}
          DARWIN_TOPIC_USER: ${{ secrets.DARWIN_TOPIC_USER }}
          DARWIN_TOPIC_PASS: ${{ secrets.DARWIN_TOPIC_PASS }}
        run: cp .env.github-testing .env
      - name: Install Dependencies
        run: sudo composer install -q --no-ansi --no-interaction --no-scripts --no-progress
      - name: Setup DynamoDb
        run: docker-compose exec -T php php artisan dynamo:setup --confirm
      - name: Run Tests
        run: docker-compose exec -T php ./vendor/bin/phpunit --coverage-clover=coverage.xml
      - name: phpunit-coverage-badge
        uses: timkrase/phpunit-coverage-badge@v1.2.0
        with:
          report: coverage.xml
          push_badge: true
          repo_token: ${{ secrets.GITHUB_TOKEN }}
